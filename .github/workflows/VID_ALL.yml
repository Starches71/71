name: Merge Shorts and Longs

on:
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Set Git Config
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "github-actions"

    - name: Merge Shorts and Longs
      run: |
        mkdir -p tmp

        for type in short long; do
          out_file="VID_ALL_${type^^}.txt"
          > tmp/tmp_$out_file

          for i in {1..7}; do
            file="vid${i}_${type}.txt"

            if [ ! -f "$file" ]; then
              echo "Missing file: $file"
              continue
            fi

            echo "Processing file: $file"
            cat "$file"

            awk '{
              if ($0 ~ /watch\?v=/) {
                match($0, /v=([a-zA-Z0-9_-]+)/, arr);
                if (arr[1] != "") {
                  print arr[1] "||" prev;
                  print $0;
                  print "";
                }
              } else {
                prev = $0;
              }
            }' "$file" >> tmp/tmp_$out_file
          done

          mv tmp/tmp_$out_file $out_file
        done

    - name: Commit and Push Results
      run: |
        git pull origin main
        git add VID_ALL_SHORT.txt VID_ALL_LONG.txt
        git commit -m "Auto-merge shorts and longs - $(date -u)"
        git push
